# hmPython3 のソースコード分析による問題点

このドキュメントは、`hmPython3` のリポジトリのルートフォルダと `hmPython3.src` フォルダを分析し、特定された潜在的な問題点をまとめたものです。

---

## 1. 保守性・可読性の問題

これらの問題は、将来の機能追加やバグ修正を困難にする可能性があります。

### 1.1. ソースファイルのエンコーディング問題 (文字化け)

- **問題点**: `hmPython3.src` 内のほぼすべてのC++ソースファイル (`.cpp`, `.h`) が、UTF-8ではなくShift-JISで保存されているようです。
- **影響**: これにより、UTF-8を標準とする多くの現代的な開発環境（エディタ、IDE）でソースファイルを開くと、コメント内の日本語がすべて文字化けしてしまいます。コードの意図を理解することが著しく困難になり、メンテナンス性を大幅に低下させています。
- **推奨される対策**: すべてのソースファイルをUTF-8エンコーディングに変換することが強く推奨されます。

### 1.2. 複雑で脆弱なマクロ呼び出しの仕組み

- **問題点**: Pythonから秀丸マクロの関数や文を呼び出す仕組み（`python_hidemaru_lib.cpp`内の`Macro_Function`, `Macro_Statement`）が非常に複雑です。
    1. Pythonの引数を、一時的な秀丸マクロ変数（例: `#AsMacroArs_12345`）に一度設定する。
    2. 呼び出すマクロのコードを文字列として動的に生成する（例: `myfunction(#AsMacroArs_12345)`）。
    3. 生成した文字列を `EvalMacro` で実行する。
    4. 戻り値は、さらに別のDLL関数呼び出しを経由して、グローバルなC++変数に一度格納されてから取得される。
- **影響**: この方法は非常に間接的で、処理の追跡が困難です。また、一時変数名が衝突しないという保証もなく、非常に脆弱です。デバッグが困難で、パフォーマンスも良くありません。
- **推奨される対策**: より直接的な方法（例えば、引数と戻り値をより効率的にやり取りできるIPC機構の利用など）で秀丸マクロと連携するよう、この部分をリファクタリングすることが望まれます。

### 1.3. 一貫性のないAPI実装

- **問題点**: 秀丸の機能をラップする方法が一貫していません。一部の機能（例: `Edit_GetTotalText`）は `CHidemaruExeExport` クラスの関数を直接呼び出していますが、他の多くの機能（例: `Edit_SetTotalText`）はマクロコードの文字列を生成して評価（Eval）することで実装されています。
- **影響**: 実装方法が混在しているため、コード全体の理解が難しくなり、メンテナンスの際にどちらの方法で修正すべきか混乱を招きます。
- **推奨される対策**: 可能であれば、より効率的で安全な直接API呼び出しに統一するか、あるいは実装方針を明確に文書化することが望ましいです。

---

## 2. 設計・アーキテクチャの問題

これらは、コードの堅牢性や拡張性に関わる問題です。

### 2.1. グローバル変数への過度な依存

- **問題点**: C++コード全体、特にエンジンの状態管理（`m_isValid`など）や、PythonとC++間のデータ受け渡し（`TestDynamicVar`）で、グローバル変数（より正確には静的変数）が多用されています。
- **影響**: グローバルな状態は、コードの様々な場所から変更される可能性があり、意図しない副作用を生みやすいです。特に `TestDynamicVar` を戻り値の受け渡しに使っている点は、スレッドセーフではなく、非常に分かりにくい設計です。
- **推奨される対策**: 状態管理をカプセル化するクラス（例: シングルトンパターン）を導入し、グローバル変数の使用を最小限に抑えるべきです。

### 2.2. Python名前空間の汚染と非分離

- **問題点**:
    1.  実行されるPythonコードは、すべて単一のグローバル名前空間（`__main__`モジュール）を共有します。これにより、別々のマクロから呼び出されたPythonスクリプトが、意図せず互いの変数や関数を上書きしてしまう危険性があります。
    2.  `hmPython.py` のラッパーは、`from hmPython import *` という使い方を推奨しているため、Pythonのグローバル名前空間に大量の関数をインポートしてしまいます。
- **影響**: コードの衝突リスクを高め、モジュール性が損なわれます。
- **推奨される対策**: スクリプトごとに独立した実行スコープ（新しいモジュールなど）を提供する仕組みを検討することが望ましいです。また、`import *` の使用は非推奨とし、`import hm` のような形での使用を推奨するようAPI設計を見直すべきです。

### 2.3. ハードコードされたエンコーディングマップ

- **問題点**: `python_hidemaru_lib.cpp` 内の `_GetEncodingParamFromHmEncode` 関数は、秀丸のエンコーディングIDとPythonのエンコーディング名を対応付けるための巨大な `switch` 文（および配列）をハードコードしています。
- **影響**: 将来、秀丸エディタが新しいエンコーディングに対応した場合、このライブラリも手動で更新しない限り対応できません。非常に壊れやすい（brittle）設計です。
- **推奨される対策**: このマッピング情報を、設定ファイルなどから動的に読み込む仕組みにすることを検討すべきです。

---

## 3. パフォーマンスの問題

### 3.1. 非効率な変数マーシャリング

- **問題点**: C++からPythonの数値変数を取得する際（`GetNumVar`）、Pythonオブジェクトから直接数値にキャストするのではなく、「Pythonオブジェクト → Python文字列 → C++文字列 → C++数値」という、複数回の非効率な変換が行われています。
- **影響**: 小さなオーバーヘッドですが、頻繁に呼ばれる場合にはパフォーマンスの低下につながる可能性があります。
- **推奨される対策**: `py::object::cast<T>()` を使用した直接的な型変換に修正すべきです。
