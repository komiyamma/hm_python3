# hmPython3 プロジェクトの問題点と改善案

このドキュメントは、`hmPython3`プロジェクトのソースコードを分析し、特定された問題点と改善案をまとめたものです。この分析は、既存コードの品質、保守性、安定性、パフォーマンスの向上に焦点を当てています。

### 1.2. ビルドの移植性と再現性の欠如

**問題点:**
Visual Studioのプロジェクトファイル (`hmPython3.vcxproj`) に、開発者のローカル環境に依存するハードコードされたパスが含まれています。

- **具体例:** Pythonのインクルードパスとして `<AdditionalIncludeDirectories>C:\usr\python\include;...` のように、`C:\usr\python` という特定のパスが指定されています。
- **影響:** 他の開発者がこのプロジェクトをクローンしても、Pythonを同じパスにインストールしない限り、そのままではビルドできません。これはプロジェクトのポータビリティを著しく低下させます。

**改善案:**
- **環境変数の利用:** Pythonのパスを指す環境変数（例: `PYTHON_HOME`）を定義し、プロジェクト設定ではその環境変数を参照する (`$(PYTHON_HOME)\include`) ように変更します。
- **ビルドシステムのモダン化:** 長期的な視点では、CMakeのようなクロスプラットフォーム対応のビルドシステムへの移行を検討します。CMakeはPythonの依存関係を自動的に発見する機能 (`find_package(Python)`) を持ち、移植性の問題を根本的に解決します。

## 2. 設計上の問題 (Architectural Issues)

### 2.1. マクロの動的生成と実行への過度な依存

**問題点:**
C++から秀丸エディタの機能を呼び出す際、多くの操作が直接的なAPI呼び出しではなく、「秀丸マクロのコード文字列を動的に生成し、それを評価・実行する」という間接的な方法に大きく依存しています。

- **具体例:**
  - `python_hidemaru_lib.cpp` の `Edit_SetTotalText` は、エディタのバッファを直接操作せず、`settotaltext dllfuncstrw(...)` というマクロ文字列を生成して `EvalMacro` で実行しています。
  - `Macro_Function` や `Macro_Statement` は、`#AsMacroArs_...` のような一時的なマクロ変数を経由して引数を渡すための複雑なマクロコードを生成します。
- **影響:**
  - **パフォーマンス低下:** 単純な操作でもマクロパーサーと実行エンジンを経由するため、オーバーヘッドが大きくなります。
  - **デバッグの困難さ:** C++のロジックとマクロのロジックが混在し、問題発生時の原因特定が困難です。
  - **複雑性の増大:** 引数渡しのためのハック的な実装は、コードを非常に複雑にし、バグの温床となります。

**改善案:**
- 可能であれば、秀丸本体が提供するより直接的なAPI（`SendMessage`など）を利用して、エディタのバッファ操作や変数アクセスを行うようにリファクタリングします。これにより、パフォーマンスと保守性が向上します。

### 2.2. 依存関係のバンドル

**問題点:**
プロジェクトリポジトリ内に、特定のバージョンのPython (`version_Python3.9.10`など) や `pybind11` ライブラリのソースコードが直接含まれています。

- **影響:**
  - **リポジトリの肥大化:** ライブラリ全体をリポジトリに含めることで、サイズが不必要に大きくなります。
  - **メンテナンスの困難さ:** 依存ライブラリのバージョンアップを手動で行う必要があり、セキュリティ脆弱性への対応が遅れる原因となります。

**改善案:**
- **Git Submoduleの利用:** `pybind11` のような外部ライブラリは、Gitのサブモジュールとして管理することを推奨します。これにより、バージョン管理が容易になり、リポジトリ本体のサイズを小さく保てます。
- **システムPythonの利用:** ユーザーがインストールしたPythonを利用するようにビルドプロセスを改善し、Python本体をリポジトリから削除します。（上記1.2の改善と関連）

## 3. コード品質と保守性の問題

### 3.1. Pythonコードの品質と一貫性の欠如

**問題点:**
- **型ヒントの不統一:** テスト用の `fake/hmPython.py` には型ヒントが付与されていますが、実際に利用される `hmPython.py` には全くありません。
- **冗長なラッパー関数:** `hmPython.py` には、秀丸の関数をラップするための定型的なコードが大量に存在します。これは手作業でメンテナンスされており、非効率です。
- **潜在的なバグ:** `hmPython.py` の `_TOutputPane` クラスに `Push` メソッドが2つ定義されています（1つは `Pop` の誤記と思われます）。

**改善案:**
- `hmPython.py` にも全面的に **型ヒントを導入** します。これにより、コードの可読性が向上し、静的解析ツールによるバグ検出が可能になります。
- `_method_proxy` のような複雑なラッパーは、よりシンプルでPythonicな実装にリファクタリングすることを検討します。
- `_TOutputPane` のバグを修正します。

### 3.2. 自動テストの欠如

**問題点:**
テスト用のモック (`fake/hmPython.py`) が用意されており、テストの基盤はありますが、実際のテストケースを記述したテストスイート（例: `pytest` を使った `test_*.py` ファイル）が存在しません。

- **影響:** 機能追加やリファクタリングの際に、意図しない変更（リグレッション）が発生しても自動的に検出できず、ソフトウェアの品質維持が困難です。

**改善案:**
- `pytest` などのモダンなテストフレームワークを導入し、`fake/hmPython.py` を利用して、主要な機能に対する単体テストと結合テストを記述します。
- GitHub ActionsなどのCI/CDツールを導入し、コードがプッシュされるたびに自動でテストが実行される環境を構築します。

### 3.3. C++コードの可読性

**問題点:**
- **コメント不足:** 文字化けの問題とは別に、C++コード、特に複雑な処理やハック的な実装が用いられている部分に、その意図を説明するコメントが不足しています。
- **エラー処理:** `MessageBox` を使ったエラー通知は、APIの呼び出し元でのプログラム的なエラーハンドリングを妨げます。

**改善案:**
- 複雑なロジックには、その **理由と動作を説明する詳細なコメントを追加** します。
- エラーは `MessageBox` ではなく、関数の戻り値や例外として呼び出し元に報告するように統一します。

---

以上の点を改善することで、`hmPython3`はより堅牢で、保守しやすく、将来的な機能拡張にも対応しやすいプロジェクトになるでしょう。
