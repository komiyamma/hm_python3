# hmPython3 プロジェクトの問題点と改善案

このドキュメントは、`hmPython3`プロジェクトのソースコードを分析し、特定された問題点と改善案をまとめたものです。機能追加の提案は含まず、既存コードの品質、保守性、安定性、パフォーマンスの向上に焦点を当てています。

## 1. ソースコードのエンコーディング問題 (文字化け)

### 問題点
C++のソースファイル (`.cpp`, `.h`) に含まれる日本語のコメントや文字列リテラルが、UTF-8として正しく認識されず、文字化け (Mojibake) を起こしています。

- **該当ファイル**: `python_engine.cpp`, `python_hidemaru_lib.cpp` など
- **原因**: ファイルがShift-JISエンコーディングで保存されている可能性が高いです。これにより、UTF-8を標準とする多くの開発環境でコードの意図を理解することが困難になっています。

### 改善案
- プロジェクト全体のソースコードのエンコーディングを**UTF-8 (BOM付き)** に統一することを強く推奨します。これにより、プラットフォームやエディタ間での互換性が向上し、保守性が大幅に改善されます。

---

## 2. 脆弱なアーキテクチャとハック

プロジェクトの根幹部分が、安定性や予測可能性を損なう可能性のある、いくつかの回避策（ハック）に依存しています。

### 問題点
- **DLLのライフサイクル管理**: `dllfunc_interface.cpp`内の`DoReferenceCounterPatch`関数は、`LoadLibrary`を自分自身のDLLに対して呼び出しています。これは、Pythonエンジンが意図せず解放されるのを防ぐためのハックであり、DLLのアンロードタイミングに問題が発生した場合、リソースリークやクラッシュの原因となり得ます。
- **データ受け渡しのためのマクロ動的生成**: C++と秀丸マクロ間のデータ受け渡し（変数設定、関数呼び出しなど）が、文字列として秀丸マクロのコードを動的に生成し、`EvalMacro`で実行するという非常に間接的な方法で行われています。
  - **例**: `Macro_SetVar`は `$=...` というマクロ文字列を生成します。`Macro_Function`は、`#AsMacroArs_...`のような一時的なマクロ変数を経由して引数を渡します。
  - この方法は非効率的であるだけでなく、非常に複雑でデバッグが困難です。
- **グローバル/静的変数の多用**:
  - `dllfunc_interface.cpp`の`GetStrVar`は、戻り値の文字列を`static wstring strvars`に格納しています。これはスレッドセーフではなく、再入可能性もありません。
  - `python_hidemaru_lib.cpp`の`Macro_GetVar`は、`TestDynamicVar`というグローバルなオブジェクトを介してマクロからの返り値を受け取っています（トランポリン）。これも同様にスレッドセーフではありません。
- **条件付きのインタプリタ解放**: `python_engine.cpp`の`Destroy`関数は、特定の条件 (`reason == 3`) の場合にのみ`py::finalize_interpreter()`を呼び出します。この条件が満たされないままDLLがアンロードされると、Pythonインタプリタが適切に解放されず、メモリリークにつながる可能性があります。

### 改善案
- **直接的なAPIの利用**: 秀丸本体が提供する、より直接的なAPI（もし存在するならば）を利用して、エディタのバッファ操作や変数アクセスを行うようにリファクタリングします。これにより、マクロの動的生成を大幅に削減できます。
- **安全なデータ受け渡し**: 呼び出し側（秀丸マクロ）がバッファを確保し、DLL側がそこに書き込む、という標準的な方法で文字列を返すように変更します。
- **ライフサイクル管理の見直し**: `py::finalize_interpreter()`が常に呼び出されるように、クリーンアップ処理のロジックを単純化・堅牢化します。

---

## 3. パフォーマンスの問題

現在の実装は、多くの箇所で非効率な処理を行っています。

### 問題点
- **マクロ実行のオーバーヘッド**: 前述の通り、単純な変数の読み書きのような基本的な操作ですら、秀丸マクロのパーサーと実行エンジンを経由しているため、パフォーマンス上の大きなオーバーヘッドが生じています。
- **非効率なデータ変換**: `python_engine.cpp`の`GetNumVar`は、Pythonオブジェクトを一度文字列に変換し、さらにそれをC++側で数値にパースし直しています。これは非常に遠回りであり、Pythonオブジェクトから直接数値型にキャストするべきです。

### 改善案
- パフォーマンスが重要な箇所では、マクロの動的生成を避け、より直接的なデータ操作方法を模索します。
- データ型変換を最適化し、不要な中間表現（文字列など）への変換をなくします。

---

## 4. コード品質と保守性の問題

コードの可読性や保守性を低下させる要因がいくつか見られます。

### 問題点
- **不適切なエラー処理**: `DoString`や`python_engine.cpp`内の多くの関数で、エラー通知に`MessageBox`が使用されています。これはAPIの呼び出し元でのプログラム的なエラーハンドリングを妨げます。また、Pythonスクリプト内で発生した例外は、その詳細が秀丸マクロ側に伝播されないため、デバッグが困難です。
- **コードの重複**: `hmPython.py`の`_TMacro._TAsStatement`と`_TMacro._TAsFunction`クラスには、引数処理に関するコードの重複が多く見られます。
- **複雑なラッパー関数**: `hmPython.py`の`_method_proxy`や、返り値の型によって処理を分岐する特殊な関数群（`_GetResultExFunction`など）は、非常に複雑で理解しにくいです。これらの実装は、秀丸マクロ変数を使ったトリッキーな方法に依存しています。
- **コメント不足**: C++側のコード、特にハックや回避策が用いられている複雑な部分に、その意図を説明するコメントが不足しています。
- **命名規則の不統一**: `hmPython.py`内で、Pythonicな`snake_case`と、クラスで一般的な`PascalCase`、そしてマクロ言語由来の`camelCase`が混在しており、一貫性がありません。
- **潜在的なバグ**: `hmPython.py`の`_TOutputPane`クラスに、`Push`メソッドが2つ定義されています（1つは`Pop`の誤記と思われます）。

### 改善案
- **エラー処理の改善**: エラーは`MessageBox`ではなく、関数の戻り値や、Python側に送出される例外として報告するように統一します。Pythonの例外情報は、スタックトレースを含めてデバッグ出力に表示されるべきです。
- **リファクタリング**:
  - `hmPython.py`内の重複コードを共通化します。
  - 可能であれば、`_method_proxy`のような複雑なラッパーを、よりシンプルでPythonicな実装（例: `__getattr__`の活用）に置き換えます。
- **ドキュメントの拡充**: 複雑なロジックや回避策には、その理由と動作を説明する詳細なコメントを追加します。
- **命名規則の統一**: `hmPython.py`ライブラリとして、より一貫した命名規則を適用することを検討します。
- **バグ修正**: `_TOutputPane`の重複した`Push`メソッドを`Pop`に修正します。
